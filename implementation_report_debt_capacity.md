# 借入金許容限度額分析機能 拡張実装完了レポート

## 1. はじめに

本レポートは、財務管理システムにおける借入金許容限度額分析機能の拡張実装が完了したことをご報告するものです。Excel「簡易新エンジン3財務管理シミュレーション」に存在する資金力分析手法のうち、未実装であった「資金力-2（安全金利法）」と「資金力--4（金利階段表）」の追加、および「担保力のパラメータ化」を完了しました。

## 2. 実装概要

今回の実装内容は以下の通りです。

| 機能分類 | 実装項目 | ステータス | 詳細 |
| :--- | :--- | :--- | :--- |
| **Method2: 安全金利法** | `calculate_debt_capacity_method2` 関数の実装 | **完了** | 売上総利益と目標利息負担率から安全な利息支払額を算出し、許容借入額を計算するロジックを `app/utils/debt_capacity_analysis.py` に実装しました。 |
| | `/debt-capacity/method2` APIエンドポイントの追加 | **完了** | 上記関数を呼び出すAPIを `app/blueprints/decision.py` に追加しました。 `fiscal_year_id` と `target_interest_burden_ratio` をパラメータとして受け取ります。 |
| **Method4: 金利階段表** | `calculate_debt_capacity_rate_table` 関数の実装 | **完了** | 利率を0.5%から8.0%まで0.5%刻みで変動させ、各金利における許容借入額をテーブル形式で返すロジックを `app/utils/debt_capacity_method13.py` に実装しました。 |
| | `/debt-capacity/method4` APIエンドポイントの追加 | **完了** | 上記関数を呼び出すAPIを `app/blueprints/decision.py` に追加しました。 `fiscal_year_id` と `standard_rate` をパラメータとして受け取ります。 |
| **担保力のパラメータ化** | `BalanceSheet` モデルの拡張 | **完了** | データベースの `balance_sheets` テーブルに `land_market_value`（土地の時価）と `securities_market_value`（有価証券の時価）のカラムが既に存在することを確認しました。 |
| | Excelインポート機能の拡張 | **完了** | Excelの「資金力-1借入金許容限度額」シートから土地・有価証券の時価を読み取り、データベースに反映する機能を実装しました。 (`app/utils/bs_market_value_importer.py`) |
| | `/excel-import/bs-market-values` APIエンドポイントの追加 | **完了** | 時価をインポートするためのAPIを `app/blueprints/excel_import_bp.py` に追加しました。 |

## 3. 実装詳細

### 3.1. Method2（安全金利法）

Excelの「資金力-2」シートのロジックに基づき、以下の計算式を実装しました。

- **安全な利息支払額** = `売上総利益` × `目標利息負担率`
- **許容負債額** = `安全な利息支払額` / `平均金利`

これにより、企業が安全に支払うことができる利息額を基準とした、現実的な借入許容額の分析が可能になります。

### 3.2. Method4（金利階段表）

Excelの「資金力--4」シートのロジックに基づき、Method3の計算式を応用して、異なる金利シナリオにおける借入許容額を一覧でシミュレーションする機能を実装しました。これにより、将来の金利変動リスクを考慮した資金調達計画の策定が容易になります。

以下の表は、テスト実行時に生成された金利階段表のサンプルです。

| 金利(%) | 許容借入額(千円) | 年間支払利息(千円) |
| :--- | :--- | :--- |
| 0.5 | 4,572,200 | 22,861 |
| 1.0 | 2,286,100 | 22,861 |
| 1.5 | 1,524,067 | 22,861 |
| 2.0 | 1,143,050 | 22,861 |
| ... | ... | ... |
| 8.0 | 285,762 | 22,861 |

### 3.3. 担保力のパラメータ化

Method1の借入金許容限度額計算で重要な要素である「担保力」について、これまで固定値や簿価で計算されていた土地・有価証券の価値を、Excelからインポートした**時価**に基づいて計算できるように改善しました。

- **読取対象シート**: `資金力-1借入金許容限度額`
- **読取対象セル**: 
    - 土地（時価）: `K8`, `L8`, `M8` (3期分)
    - 有価証券（時価）: `K9`, `L9`, `M9` (3期分)

これにより、より実態に即した担保価値を評価し、精度の高い借入限度額分析が可能となります。

## 4. テスト

実装した各機能について、データベース接続を必要としない簡易的な単体テストを実施し、すべてのロジックが期待通りに動作することを確認しました。APIエンドポイントの追加も確認済みです。

## 5. 今後のステップ

- **フロントエンドの実装**: 今回追加したAPIを呼び出し、分析結果を画面に表示するフロントエンド画面の実装。
- **総合テスト**: フロントエンドとバックエンドを結合した状態での総合テスト。
- **デプロイ**: テスト完了後、本番環境へのデプロイ。

以上で、借入金許容限度額分析機能の拡張実装は完了です。
