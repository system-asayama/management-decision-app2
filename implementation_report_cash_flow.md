# 資金調達返済計画・資金繰り計画機能 拡張実装完了レポート

## 1. はじめに

本レポートは、財務管理システムにおける資金調達返済計画および資金繰り計画機能の拡張実装が完了したことをご報告するものです。ご指示いただいた「資金繰り表の自動生成」と「UI表示の改善」を実装しました。

## 2. 実装概要

今回の実装内容は以下の通りです。

| 機能分類 | 実装項目 | ステータス | 詳細 |
| :--- | :--- | :--- | :--- |
| **資金繰り表の自動生成** | 統合資金繰り計画モジュールの作成 | **完了** | 営業・投資・財務の各キャッシュフローを統合し、月次の資金繰り表を生成する `integrated_cash_flow_planner.py` を新規作成しました。 |
| | 残高不足警告ロジックの実装 | **完了** | 生成された資金繰り表に基づき、現金残高が事前に設定した最低必要残高を下回る場合に警告を生成する機能を実装しました。 |
| | 資金調達提案機能の実装 | **完了** | 資金不足が検出された場合に、不足額を補うための短期借入などの資金調達案を提示する機能を実装しました。 |
| | `/cash-flow/integrated-monthly-plan` APIエンドポイントの追加 | **完了** | 統合資金繰り表、警告、資金調達提案を返すAPIを `app/blueprints/decision.py` に追加しました。 |
| **UI表示の改善** | 返済計画フォーマッターモジュールの作成 | **完了** | 各種計算結果をUIのテーブル表示に適したJSON形式に整形する `repayment_plan_formatter.py` を新規作成しました。 |
| | 返済計画関連APIの追加 | **完了** | 償却スケジュール、借換え効果比較などを整形済みJSONで返すためのAPIを `app/blueprints/decision.py` に追加しました。 |

## 3. 実装詳細

### 3.1. 資金繰り表の自動生成 (`integrated_cash_flow_planner.py`)

Excelの「⑦初年度資金繰り計画」シートの概念を基に、より動的で統合的な資金繰り表生成ロジックを構築しました。このモジュールは、以下の機能を提供します。

- **キャッシュフローの統合**: 営業CF、投資CF、財務CFを月次で集計し、最終的な現金の増減と期末残高を計算します。
- **残高不足の自動検出**: 各月の期末現金残高が、ユーザーが設定した「最低必要現金残高」を下回った場合に、その月と不足額を特定し、警告リストを生成します。
- **警告レベル**: 残高がマイナスになった場合は「重大(critical)」、最低残高を下回った場合は「警告(warning)」としてレベル分けします。
- **資金調達の提案**: 検出された最大の資金不足額に基づき、安全マージン（10%）を加えた上で、具体的な資金調達額とアクション（例：短期借入）を提案します。

### 3.2. UI表示の改善 (`repayment_plan_formatter.py`)

バックエンドで計算された各種の計画数値を、フロントエンドで直接テーブルとして描画できるよう、整形処理を共通化しました。これにより、フロントエンド側の負担を軽減し、表示の一貫性を保ちます。

- **償却スケジュールの整形**: 月々の返済額、元金、利息、残高を一覧テーブル用のデータ構造に変換します。
- **借換え・繰上返済効果の整形**: 「現在」と「変更後」の数値を並べて比較できるようなテーブル形式に変換し、削減効果や推奨事項を明確に提示します。
- **金額のフォーマット**: すべての金額は、`1,234,567円` のように桁区切りと単位を付与した文字列としても提供し、UIでの表示を容易にします。

## 4. テスト

実装した各機能について、データベース接続を必要としない簡易的な単体テストを実施し、資金繰り表の生成、残高不足の警告、UI用データ整形がすべて期待通りに動作することを確認しました。APIエンドポイントの追加も確認済みです。

## 5. 今後のステップ

- **フロントエンドの実装**: 今回追加したAPIを呼び出し、資金繰り表や返済計画を画面に表示するフロントエンド画面の実装。
- **データ連携の強化**: 現在は簡易的にPLデータから営業CFを計算していますが、今後は設備投資計画や実際の借入返済計画データと連携し、より精度の高い資金繰り予測を実現します。
- **総合テスト**: フロントエンドとバックエンドを結合した状態での総合テスト。

以上で、資金調達返済計画・資金繰り計画機能の拡張実装は完了です。
