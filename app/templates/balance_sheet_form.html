{% extends "base.html" %}

{% block title %}{% if balance_sheet %}貸借対照表編集{% else %}貸借対照表登録{% endif %}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">{% if balance_sheet %}貸借対照表編集{% else %}貸借対照表登録{% endif %}</h1>
        
        <p class="text-gray-600 mb-6">貸借対照表の情報を入力してください。</p>
        
        <form method="POST" class="bg-white rounded-lg shadow p-6">
            <!-- 会計年度選択 -->
            <div class="mb-6">
                <label for="fiscal_year_id" class="block text-sm font-medium text-gray-700 mb-2">
                    会計年度 <span class="text-red-500">*</span>
                </label>
                <select id="fiscal_year_id" name="fiscal_year_id" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                    <option value="">選択してください</option>
                    {% for fy in fiscal_years %}
                    <option value="{{ fy.id }}" {% if balance_sheet and balance_sheet.fiscal_year_id == fy.id %}selected{% endif %}>
                        {{ fy.company.name }} - {{ fy.year_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- 資産 -->
            <div class="mb-6 border-b pb-6">
                <h2 class="text-xl font-semibold mb-4 text-green-700">資産</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="current_assets" class="block text-sm font-medium text-gray-700 mb-2">
                            流動資産（円）
                        </label>
                           <input type="text" id="current_assets" name="current_assets" 
                               value="{% if balance_sheet %}{{ balance_sheet.current_assets }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*">
                    </div>
                    
                    <div>
                        <label for="fixed_assets" class="block text-sm font-medium text-gray-700 mb-2">
                            固定資産（円）
                        </label>
                           <input type="text" id="fixed_assets" name="fixed_assets" 
                               value="{% if balance_sheet %}{{ balance_sheet.fixed_assets }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="total_assets" class="block text-sm font-medium text-gray-700 mb-2">
                            総資産（円）
                        </label>
                           <input type="text" id="total_assets" name="total_assets" 
                               value="{% if balance_sheet %}{{ balance_sheet.total_assets }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent bg-gray-50 font-bold js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*"
                               readonly>
                    </div>
                </div>
            </div>
            
            <!-- 負債 -->
            <div class="mb-6 border-b pb-6">
                <h2 class="text-xl font-semibold mb-4 text-blue-700">負債</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="current_liabilities" class="block text-sm font-medium text-gray-700 mb-2">
                            流動負債（円）
                        </label>
                           <input type="text" id="current_liabilities" name="current_liabilities" 
                               value="{% if balance_sheet %}{{ balance_sheet.current_liabilities }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*">
                    </div>
                    
                    <div>
                        <label for="fixed_liabilities" class="block text-sm font-medium text-gray-700 mb-2">
                            固定負債（円）
                        </label>
                           <input type="text" id="fixed_liabilities" name="fixed_liabilities" 
                               value="{% if balance_sheet %}{{ balance_sheet.fixed_liabilities }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="total_liabilities" class="block text-sm font-medium text-gray-700 mb-2">
                            総負債（円）
                        </label>
                           <input type="text" id="total_liabilities" name="total_liabilities" 
                               value="{% if balance_sheet %}{{ balance_sheet.total_liabilities }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent bg-gray-50 font-bold js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*"
                               readonly>
                    </div>
                </div>
            </div>
            
            <!-- 純資産 -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4 text-purple-700">純資産</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="capital" class="block text-sm font-medium text-gray-700 mb-2">
                            資本金（円）
                        </label>
                           <input type="text" id="capital" name="capital" 
                               value="{% if balance_sheet %}{{ balance_sheet.capital }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*">
                    </div>
                    
                    <div>
                        <label for="retained_earnings" class="block text-sm font-medium text-gray-700 mb-2">
                            利益剰余金（円）
                        </label>
                           <input type="text" id="retained_earnings" name="retained_earnings" 
                               value="{% if balance_sheet %}{{ balance_sheet.retained_earnings }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="total_equity" class="block text-sm font-medium text-gray-700 mb-2">
                            純資産合計（円）
                        </label>
                           <input type="text" id="total_equity" name="total_equity" 
                               value="{% if balance_sheet %}{{ balance_sheet.total_equity }}{% else %}0{% endif %}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent bg-gray-50 font-bold js-comma-int"
                               inputmode="numeric" pattern="[0-9,]*"
                               readonly>
                    </div>
                </div>
                
                <!-- バランスチェック -->
                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-800">
                        <strong>バランスチェック:</strong> 総資産 = 総負債 + 純資産
                    </p>
                    <p id="balance_check" class="text-sm mt-2"></p>
                </div>
            </div>
            
            <!-- ボタン -->
            <div class="flex gap-4">
                <a href="{{ url_for('decision.balance_sheet_list') }}" 
                   class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    キャンセル
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    {% if balance_sheet %}更新{% else %}登録{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// 自動計算機能
document.addEventListener('DOMContentLoaded', function() {
    const currentAssets = document.getElementById('current_assets');
    const fixedAssets = document.getElementById('fixed_assets');
    const totalAssets = document.getElementById('total_assets');
    const currentLiabilities = document.getElementById('current_liabilities');
    const fixedLiabilities = document.getElementById('fixed_liabilities');
    const totalLiabilities = document.getElementById('total_liabilities');
    const capital = document.getElementById('capital');
    const retainedEarnings = document.getElementById('retained_earnings');
    const totalEquity = document.getElementById('total_equity');
    const balanceCheck = document.getElementById('balance_check');
    
    function parseMoney(value) {
        const s = String(value || '').replace(/,/g, '').trim();
        const n = parseInt(s || '0', 10);
        return isNaN(n) ? 0 : n;
    }

    function formatMoney(value) {
        const n = parseInt(String(value || '0'), 10);
        if (isNaN(n)) return '0';
        return n.toLocaleString('ja-JP');
    }

    function calculate() {
        // 総資産 = 流動資産 + 固定資産
        const ta = parseMoney(currentAssets.value) + parseMoney(fixedAssets.value);
        totalAssets.value = formatMoney(ta);

        // 総負債 = 流動負債 + 固定負債
        const tl = parseMoney(currentLiabilities.value) + parseMoney(fixedLiabilities.value);
        totalLiabilities.value = formatMoney(tl);

        // 純資産合計 = 資本金 + 利益剰余金
        const te = parseMoney(capital.value) + parseMoney(retainedEarnings.value);
        totalEquity.value = formatMoney(te);

        // バランスチェック: 総資産 = 総負債 + 純資産
        const diff = ta - (tl + te);
        if (diff === 0) {
            balanceCheck.innerHTML = '<span class="text-green-600">✓ バランスが取れています</span>';
        } else {
            balanceCheck.innerHTML = '<span class="text-red-600">⚠ 差額: ' + diff.toLocaleString() + ' 円</span>';
        }
    }
    
    // 各入力フィールドに変更イベントを追加
    [currentAssets, fixedAssets, currentLiabilities, fixedLiabilities, capital, retainedEarnings].forEach(field => {
        field.addEventListener('input', calculate);
    });
    
    // 初期計算
    calculate();
});
</script>
{% endblock %}
