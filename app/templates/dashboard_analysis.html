{% extends "base.html" %}

{% block title %}ダッシュボード分析{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">ダッシュボード分析</h1>
        
        <p class="text-gray-600 mb-6">企業と会計年度を選択して財務分析を実行します。</p>
        
        <!-- 企業・年度選択 -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">分析対象選択</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="company_id" class="block text-sm font-medium text-gray-700 mb-2">
                        企業 <span class="text-red-500">*</span>
                    </label>
                    <select id="company_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">選択してください</option>
                        {% for company in companies %}
                        <option value="{{ company.id }}">{{ company.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="fiscal_year_id" class="block text-sm font-medium text-gray-700 mb-2">
                        会計年度 <span class="text-red-500">*</span>
                    </label>
                    <select id="fiscal_year_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" disabled>
                        <option value="">まず企業を選択してください</option>
                    </select>
                </div>
                
                <div class="flex items-end">
                    <button id="analyze_btn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                        分析実行
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 分析結果表示エリア -->
        <div id="analysis_result" class="hidden">
            <!-- 基本情報 -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-lg font-semibold text-blue-800 mb-2" id="result_title"></h3>
                <p class="text-blue-600" id="result_subtitle"></p>
            </div>
            
            <!-- 財務指標カード -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- 収益性指標 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-green-700">収益性指標</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">売上高営業利益率</span>
                            <span id="operating_profit_margin" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">売上高経常利益率</span>
                            <span id="ordinary_profit_margin" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">売上高当期純利益率</span>
                            <span id="net_profit_margin" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t">
                            <span class="text-sm text-gray-600">ROA</span>
                            <span id="roa" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">ROE</span>
                            <span id="roe" class="font-bold"></span>
                        </div>
                    </div>
                </div>
                
                <!-- 安全性指標 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-blue-700">安全性指標</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">流動比率</span>
                            <span id="current_ratio" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">固定比率</span>
                            <span id="fixed_ratio" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">自己資本比率</span>
                            <span id="equity_ratio" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">負債比率</span>
                            <span id="debt_ratio" class="font-bold"></span>
                        </div>
                    </div>
                </div>
                
                <!-- 効率性指標 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4 text-purple-700">効率性指標</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">総資産回転率</span>
                            <span id="total_asset_turnover" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">固定資産回転率</span>
                            <span id="fixed_asset_turnover" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">流動資産回転率</span>
                            <span id="current_asset_turnover" class="font-bold"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- グラフ表示エリア -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">損益計算書</h3>
                    <canvas id="plChart"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">貸借対照表</h3>
                    <canvas id="bsChart"></canvas>
                </div>
            </div>
            
            <!-- 複数年度推移グラフ -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">売上高・利益推移</h3>
                <canvas id="multiYearChart"></canvas>
            </div>
        </div>
        
        <div class="mt-6">
            <a href="{{ url_for('decision.index') }}" class="text-blue-600 hover:text-blue-700">← メニューに戻る</a>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
let plChart, bsChart, multiYearChart;

// 企業選択時に会計年度を取得
document.getElementById('company_id').addEventListener('change', async function() {
    const companyId = this.value;
    const fiscalYearSelect = document.getElementById('fiscal_year_id');
    const analyzeBtn = document.getElementById('analyze_btn');
    
    if (!companyId) {
        fiscalYearSelect.disabled = true;
        fiscalYearSelect.innerHTML = '<option value="">まず企業を選択してください</option>';
        analyzeBtn.disabled = true;
        return;
    }
    
    try {
        const response = await fetch(`/decision/fiscal-years/by-company/${companyId}`);
        const data = await response.json();
        
        if (data.success) {
            fiscalYearSelect.disabled = false;
            fiscalYearSelect.innerHTML = '<option value="">選択してください</option>';
            data.fiscal_years.forEach(fy => {
                const option = document.createElement('option');
                option.value = fy.id;
                option.textContent = fy.year_name;
                fiscalYearSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('会計年度の取得に失敗しました:', error);
        alert('会計年度の取得に失敗しました');
    }
});

// 会計年度選択時に分析ボタンを有効化
document.getElementById('fiscal_year_id').addEventListener('change', function() {
    const analyzeBtn = document.getElementById('analyze_btn');
    analyzeBtn.disabled = !this.value;
});

// 分析実行
document.getElementById('analyze_btn').addEventListener('click', async function() {
    const companyId = document.getElementById('company_id').value;
    const fiscalYearId = document.getElementById('fiscal_year_id').value;
    
    if (!companyId || !fiscalYearId) {
        alert('企業と会計年度を選択してください');
        return;
    }
    
    try {
        // 単年度データを取得
        const response = await fetch(`/decision/dashboard-analysis/data/${companyId}/${fiscalYearId}`);
        const data = await response.json();
        
        if (!data.success) {
            alert(data.error);
            return;
        }
        
        // 結果を表示
        displayAnalysisResult(data);
        
        // 複数年度データを取得
        const multiYearResponse = await fetch(`/decision/dashboard-analysis/multi-year/${companyId}`);
        const multiYearData = await multiYearResponse.json();
        
        if (multiYearData.success) {
            displayMultiYearChart(multiYearData.data);
        }
        
    } catch (error) {
        console.error('分析の実行に失敗しました:', error);
        alert('分析の実行に失敗しました');
    }
});

function displayAnalysisResult(data) {
    // 結果エリアを表示
    document.getElementById('analysis_result').classList.remove('hidden');
    
    // タイトル
    document.getElementById('result_title').textContent = data.company_name;
    document.getElementById('result_subtitle').textContent = data.fiscal_year_name;
    
    // 収益性指標
    displayRatio('operating_profit_margin', data.ratios.profitability.operating_profit_margin, '%');
    displayRatio('ordinary_profit_margin', data.ratios.profitability.ordinary_profit_margin, '%');
    displayRatio('net_profit_margin', data.ratios.profitability.net_profit_margin, '%');
    displayRatio('roa', data.ratios.roa_roe.roa, '%');
    displayRatio('roe', data.ratios.roa_roe.roe, '%');
    
    // 安全性指標
    displayRatio('current_ratio', data.ratios.safety.current_ratio, '%');
    displayRatio('fixed_ratio', data.ratios.safety.fixed_ratio, '%');
    displayRatio('equity_ratio', data.ratios.safety.equity_ratio, '%');
    displayRatio('debt_ratio', data.ratios.safety.debt_ratio, '%');
    
    // 効率性指標
    displayRatio('total_asset_turnover', data.ratios.efficiency.total_asset_turnover, '回');
    displayRatio('fixed_asset_turnover', data.ratios.efficiency.fixed_asset_turnover, '回');
    displayRatio('current_asset_turnover', data.ratios.efficiency.current_asset_turnover, '回');
    
    // 損益計算書グラフ
    displayPLChart(data.profit_loss);
    
    // 貸借対照表グラフ
    displayBSChart(data.balance_sheet);
}

function displayRatio(id, ratioData, unit) {
    const element = document.getElementById(id);
    element.textContent = ratioData.value + unit;
    
    // 色分け
    element.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
    if (ratioData.status === 'success') {
        element.classList.add('text-green-600');
    } else if (ratioData.status === 'warning') {
        element.classList.add('text-yellow-600');
    } else if (ratioData.status === 'danger') {
        element.classList.add('text-red-600');
    }
}

function displayPLChart(profitLoss) {
    const ctx = document.getElementById('plChart');
    
    if (plChart) {
        plChart.destroy();
    }
    
    plChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['売上高', '売上原価', '粗利益', '販管費', '営業利益', '経常利益', '当期純利益'],
            datasets: [{
                label: '金額（円）',
                data: [
                    profitLoss.sales,
                    -profitLoss.cost_of_sales,
                    profitLoss.gross_profit,
                    -profitLoss.operating_expenses,
                    profitLoss.operating_income,
                    profitLoss.ordinary_income,
                    profitLoss.net_income
                ],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.5)',
                    'rgba(239, 68, 68, 0.5)',
                    'rgba(34, 197, 94, 0.5)',
                    'rgba(239, 68, 68, 0.5)',
                    'rgba(34, 197, 94, 0.5)',
                    'rgba(34, 197, 94, 0.5)',
                    'rgba(34, 197, 94, 0.5)'
                ],
                borderColor: [
                    'rgb(59, 130, 246)',
                    'rgb(239, 68, 68)',
                    'rgb(34, 197, 94)',
                    'rgb(239, 68, 68)',
                    'rgb(34, 197, 94)',
                    'rgb(34, 197, 94)',
                    'rgb(34, 197, 94)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function displayBSChart(balanceSheet) {
    const ctx = document.getElementById('bsChart');
    
    if (bsChart) {
        bsChart.destroy();
    }
    
    bsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['資産', '負債・純資産'],
            datasets: [
                {
                    label: '流動資産',
                    data: [balanceSheet.current_assets, 0],
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                },
                {
                    label: '固定資産',
                    data: [balanceSheet.fixed_assets, 0],
                    backgroundColor: 'rgba(147, 51, 234, 0.5)',
                    borderColor: 'rgb(147, 51, 234)',
                    borderWidth: 1
                },
                {
                    label: '流動負債',
                    data: [0, balanceSheet.current_liabilities],
                    backgroundColor: 'rgba(239, 68, 68, 0.5)',
                    borderColor: 'rgb(239, 68, 68)',
                    borderWidth: 1
                },
                {
                    label: '固定負債',
                    data: [0, balanceSheet.fixed_liabilities],
                    backgroundColor: 'rgba(251, 146, 60, 0.5)',
                    borderColor: 'rgb(251, 146, 60)',
                    borderWidth: 1
                },
                {
                    label: '純資産',
                    data: [0, balanceSheet.total_equity],
                    backgroundColor: 'rgba(34, 197, 94, 0.5)',
                    borderColor: 'rgb(34, 197, 94)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    stacked: true,
                    beginAtZero: true
                }
            }
        }
    });
}

function displayMultiYearChart(data) {
    const ctx = document.getElementById('multiYearChart');
    
    if (multiYearChart) {
        multiYearChart.destroy();
    }
    
    const labels = data.map(d => d.fiscal_year_name);
    const sales = data.map(d => d.sales);
    const operatingIncome = data.map(d => d.operating_income);
    const ordinaryIncome = data.map(d => d.ordinary_income);
    const netIncome = data.map(d => d.net_income);
    
    multiYearChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '売上高',
                    data: sales,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1
                },
                {
                    label: '営業利益',
                    data: operatingIncome,
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.1
                },
                {
                    label: '経常利益',
                    data: ordinaryIncome,
                    borderColor: 'rgb(147, 51, 234)',
                    backgroundColor: 'rgba(147, 51, 234, 0.1)',
                    tension: 0.1
                },
                {
                    label: '当期純利益',
                    data: netIncome,
                    borderColor: 'rgb(251, 146, 60)',
                    backgroundColor: 'rgba(251, 146, 60, 0.1)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}
</script>
{% endblock %}
